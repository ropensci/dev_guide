# Mejores prácticas de integración continua {#ci}

```{block, type="summaryblock"}
Este capítulo resume nuestras directrices sobre la integración continua después de explicar qué es la integración continua.

Junto con el [último capítulo](#construcción), forma nuestras directrices para la revisión por pares del software.
```

## ¿Qué es la integración continua (IC)?

La integración continua ejecuta automáticamente pruebas sobre el software.
En el caso de rOpenSci, CI significa prácticamente que un conjunto de pruebas se ejecutará automáticamente a través de GitHub, cada vez que hagas un commit o pull request a GitHub.

CI automatiza la ejecución de comprobaciones generales de paquetes como `Comprobación de R CMD`ver [pruebas](/building.html#testing).
Es posible configurar CI antes de escribir tus pruebas, entonces CI ejecutará las pruebas a medida que las envíes al repositorio.

## ¿Por qué utilizar la integración continua (CI)?

Todos los paquetes de rOpenSci deben utilizar una forma de integración continua.
Esto asegura que todos los commits, pull requests y nuevas ramas se ejecutan a través de `R CMD check`.
Los resultados de todas las pruebas se muestran en la página de pull request en GitHub, proporcionando otra capa de información sobre los problemas y la protección contra la ruptura de tu paquete antes de fusionar los cambios.
La integración continua de los paquetes de rOpenSci también debe estar vinculada a un servicio de cobertura de código, que indique cuántas líneas están cubiertas por las pruebas unitarias.

Tanto el estado de las pruebas como la cobertura del código deben informarse mediante insignias en el README de tu paquete.

Los paquetes de R deben tener CI para todos los sistemas operativos (Linux, Mac OSX, Windows) cuando contengan

- Código compilado

- Dependencias de Java

- Dependencias de otros lenguajes

- Paquetes con llamadas al sistema

- Munición de texto, como obtener los nombres de las personas (para encontrar problemas de codificación).

- Cualquier cosa con llamadas al sistema de archivos / ruta de acceso

En caso de duda sobre la aplicabilidad de estos criterios a tu paquete, es mejor añadir CI para todos los sistemas operativos. La mayoría de las configuraciones estándar de los servicios de IC para los paquetes de R lo permiten sin mucha complicación.

## ¿Qué servicio(s) de integración continua? {#whichci}

Hay varios servicios de integración continua, incluyendo servicios independientes (CircleCI, AppVeyor), y otros integrados en el alojamiento de código o servicios relacionados (GitHub Actions, GitLab, AWS Code Pipeline). Los distintos servicios admiten diferentes configuraciones de sistemas operativos.

[GitHub Actions](https://github.com/features/actions) es una opción conveniente para muchos desarrolladores de R que ya utilizan GitHub, ya que está integrado en la plataforma y es compatible con todos los sistemas operativos necesarios.  Hay [acciones compatibles con el ecosistema R](https://github.com/r-lib/actions/)así como soporte de primera clase en el [{usar esto}](https://usethis.r-lib.org/reference/github_actions.html) paquete. Todos los paquetes enviados a rOpenSci para su revisión por pares son comprobados por nuestro propio [`pkgcheck` sistema](https://docs.ropensci.org/pkgcheck)que se describe con más detalle en la [Guía para los autores](#authors-guide). Estas comprobaciones también se proporcionan como una acción de GitHub en el archivo [`ropensci-review-tools/pkgcheck-action` del repositorio](https://github.com/ropensci-review-tools/pkgcheck-action). Se anima a los autores de paquetes a que utilicen esa acción para confirmar, antes de su envío, que un paquete pasa todas nuestras comprobaciones. Ver [nuestra publicación en el blog](https://ropensci.org/blog/2022/02/01/pkgcheck-action/) para más información.

[usethis soporta la configuración de CI para otros sistemas](https://usethis.r-lib.org/reference/ci.html)aunque estas funciones están en desuso. rOpenSci también admite la función [círculo](https://docs.ropensci.org/circle/) que ayuda a configurar las canalizaciones de CircleCI, y el paquete [tic](https://docs.ropensci.org/tic/) para la construcción de cadenas de CI más complicadas.

#### Pruebas con diferentes versiones de R

Exigimos que los paquetes de rOpenSci se prueben con las versiones más recientes, anteriores y de desarrollo de R para garantizar la compatibilidad con R base, tanto hacia atrás como hacia delante.

Los detalles de cómo ejecutar pruebas/comprobaciones utilizando diferentes versiones de R localmente se pueden encontrar en la viñeta de R-hub sobre la ejecución de [Comprobaciones locales en Linux con Docker](https://r-hub.github.io/rhub/articles/local-debugging.html).

Puedes afinar el despliegue de pruebas con cada una de las versiones utilizando una matriz de pruebas.

Si desarrollas un paquete que depende de Bioconductor o está destinado a él, puede que encuentres [biocthis](https://lcolladotor.github.io/biocthis/index.html) relevante.

#### Minimizar los tiempos de construcción en CI

Puedes utilizar estos consejos para minimizar el tiempo de compilación en CI:

- Almacenar en caché la instalación de los paquetes. La opción por defecto [r-lib/actions](https://github.com/r-lib/actions) hacen esto.

### Travis CI (Linux y Mac OSX)

Recomendamos [alejarse de Travis](https://ropensci.org/technotes/2020/11/19/moving-away-travis/).

### AppVeyor CI (Windows)

Para la integración continua en Windows, consulta [R + AppVeyor](https://github.com/krlmlr/r-appveyor). Configúralo con `usethis::use_appveyor()`.

Aquí tienes consejos para minimizar el tiempo de compilación de AppVeyor:

- Almacena la instalación de los paquetes. [Ejemplo en un archivo de configuración](https://github.com/r-lib/usethis/blob/2c52c06373849d52f78a26c5a0e080f518a2f825/inst/templates/appveyor.yml#L13). Ya estará en el archivo de configuración si configuras AppVeyor CI con `usethis::use_appveyor()`.

- Activa [construcciones rodantes](https://www.appveyor.com/docs/build-configuration/#rolling-builds).

Ya no transferimos los proyectos de AppVeyor a la cuenta de AppVeyor de ropensci, así que después de transferir tu repo a la organización de GitHub "ropensci" de rOpenSci, la insignia será `[![Estado de construcción de AppVeyor](https://ci.appveyor.com/api/projects/status/github/ropensci/pkgname?branch=master&svg=true)](https://ci.appveyor.com/project/individualaccount/pkgname)`.

### Circle CI (Linux y Mac OSX)

[El Circle CI](https://circleci.com/) es utilizado, por ejemplo, por el paquete rOpenSci [`bomrang`](https://github.com/ropensci/bomrang) como servicio de integración continua.

## Cobertura de pruebas {#cobertura}

La integración continua también debe incluir la notificación de la cobertura de las pruebas a través de un servicio de pruebas como [Codecov](https://codecov.io/) o [Coveralls](https://coveralls.io/).

Recomendamos utilizar Codecov.
Para activar Codecov para tu repo, ejecuta `usethis::use_github_action("test-coverage")` para crear un archivo `.github/workflows/prueba-cobertura.yaml`.
También tienes que dar acceso a Codecov a tu repositorio de github, ver [Guía de inicio rápido de Codecov](https://docs.codecov.com/docs/quick-start) para saber cómo configurar el acceso.
A continuación, añade una insignia de estado de Codecov en la parte superior de tu README.md, consulta [Insignias de estado de Codecov](https://docs.codecov.com/docs/status-badges).

Actualmente, Codecov tiene acceso a todos los repositorios de github de ropensci por defecto.
Cuando tu repositorio sea aceptado y transferido a ropensci, el acceso de Codecov debería transferirse automáticamente.
Tendrás que actualizar la URL de la insignia para que apunte al repositorio alojado en rOpenSci.

Para más detalles, consulta el [README del programa **covr** del paquete](https://github.com/r-lib/covr) para obtener instrucciones, así como [`usethis::usar_cobertura()`](https://usethis.r-lib.org/reference/use_coverage.html) y [`usethis::use_github_action()`](https://usethis.r-lib.org/reference/github_actions.html).

Si ejecutas la cobertura en varios servicios CI [los resultados se fusionarán](https://docs.codecov.io/docs/merging-reports).

## Más CI: OpenCPU

Después de la transferencia a la organización GitHub "ropensci" de rOpenSci, cada empuje al repo se construirá en OpenCPU y la persona que hace el commit recibirá un correo electrónico de notificación. Este es un servicio adicional de CI para los autores de paquetes que permite llamar a las funciones de R en los paquetes de forma remota a través de [https://ropensci.ocpu.io/](https://ropensci.ocpu.io/) utilizando la [API de opencpu](https://www.opencpu.org/api.html#api-json). Para más detalles sobre este servicio, consulta la página de ayuda de OpenCPU [página de ayuda](https://www.opencpu.org/help.html) que también indica dónde hacer preguntas.

## Aún más CI: rOpenSci docs {#rodocsci}

Después de la transferencia a la organización GitHub "ropensci" de rOpenSci, se construirá un sitio web pkgdown para tu paquete después de cada empuje al repo de GitHub. Puedes encontrar el estado de estas construcciones en `https://dev.ropensci.org/job/package_name`por ejemplo [para `magick`](https://dev.ropensci.org/job/magick)y el sitio web en `https://docs.ropensci.org/package_name`por ejemplo [para `magick`](https://docs.ropensci.org/magick). La construcción del sitio web utilizará tu archivo de configuración pkgdown si tienes uno, excepto el estilo que utilizará el [`rotemplate` paquete](https://github.com/ropensci-org/rotemplate/). Por favor, informa de los errores, preguntas y peticiones de características sobre las construcciones centrales en [https://github.com/ropensci/docs/](https://github.com/ropensci/docs/) y sobre la plantilla en [https://github.com/ropensci-org/rotemplate/](https://github.com/ropensci-org/rotemplate/).


